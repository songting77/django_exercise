# 生成图片验证码

1 获得一个画布

2 实例化一个画笔

3 实例化字体

4 使用画笔 画对应的字符

5 保存验证码图片

6 将生成的四个随机字符 写入session 留着验证用

7 将图片返回给浏览器

获得随机颜色

~~~
import random

# 获得随机颜色
def get_random_color():
    R = random.randrange(255)
    G = random.randrange(255)
    B = random.randrange(255)
    return (R, G, B)
~~~



~~~
import random

# Create your views here.

def get_verify_img(req):
    # 画布背景颜色
    bg_color = get_random_color()
    img_size = (130, 70)
    # 实例化一个画布
    image = Image.new("RGB", img_size, bg_color)
    # 实例化画笔
    draw = ImageDraw.Draw(image, "RGB")
    # 设置文字的颜色
    # text_color = (255, 0, 0)
    # 创建字体
    font_path = "/home/liuda/gz1083/codes/day07/static/fonts/ADOBEARABIC-BOLDITALIC.OTF"
    # 实例化字体 并指定大小是30
    font = ImageFont.truetype(font_path, 30)
    #准备源字符集
    source = "abcdefghijklmnopqrstJHHKJLHKHATQWERTYUIOPXCVBNM<DFGHJKL1234567890"

    # 保存每次随出来的字符
    code_str = ""
    for i in range(4):
    	#获得随机颜色
        text_color = get_random_color()
        # 获得随机数字
        tmp_num = random.randrange(len(source))
        # 获得随机字符
        random_str = source[tmp_num]
        # 将每次随机得到字符保存
        code_str += random_str
        # 将字符画到画布上
        draw.text((10 + 30*i, 20), random_str, text_color, font)

    # 记录给哪个请求发了什么验证码
    req.session['code'] = code_str

    # 使用画笔将文字画到画布上
    # draw.text((10, 20), "X", text_color, font)
    # draw.text((40, 20), "z", text_color, font)
    # draw.text((60, 20), "9", text_color, font)

    # 获得一个缓存区
    buf = io.BytesIO()
    # 将图片保存到缓存区
    image.save(buf, 'png')
    # 将缓存区的内容 返回给前端
    return HttpResponse(buf.getvalue(), 'image/png')
~~~

# 图片验证码的使用

后端逻辑

~~~
def login_api(req):
    if req.method == 'GET':
        return render(req, 'login.html')
    else:
        params = req.POST
        # 用户输入的
        code = params.get("verify_code")
        # 从session获取的
        server_code = req.session.get("code")
        #  做判断比较
        if server_code.lower() == code.lower():
            return HttpResponse("ok")
        else:
            return HttpResponse("fail")
~~~

前端

~~~
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>

</head>
<body>
    <form action="/t7/login" method="post" style="text-align: center">
        {%csrf_token%}
        <input type="text" placeholder="用户名" name="u_name">
        <br/>
        <!--放图片验证码-->
        <img src="/t7/verify_img" alt="" id="code">
        <br>
        <input type="text" placeholder="验证码" name="verify_code">
        <br>
        <input type="submit" value="登录">
    </form>
</body>
<script>
		#给图片添加点击事件
        $("#code").click(function () {
           #修改 图片的src属性
            $(this).attr("src", "/t7/verify_img" + Math.random());

        })
    </script>
</html>
~~~

# 站点管理

## 创建超级用户

​	python manage.py createsuperuser

## 管理我们自己的类

​	1 在admin.py里注册 我们自己的类到系统的站点管理 最简单的写法

~~~
admin.site.register(你的类名)
~~~

​	2 功能不够使用的时候 我们可以自己创建一个自定义的管理类

~~~
class PlayerAdmin(admin.ModelAdmin):

    def get_rate_level(self):
        if self.rate >=9:
            return "好东西"
        else:
            return "卸载吧"
    get_rate_level.short_description = "评价"

    # 显示的字段
    list_display = ['name', 'rate', get_rate_level]
    # 过滤的条件
    list_filter = ['rate', 'desc']
    # 搜索的字段
    search_fields = ['name', 'rate']
    # 分页
    list_per_page = 1
    # 信息分组
    fieldsets = [
        ("基本信息", {'fields': ("name", "desc", )}),
        ("附加信息", {'fields': ("rate", )})
    ]
~~~

3 将自定义管理类注册到 admin里

~~~
admin.site.register(Player, PlayerAdmin)
~~~



## 自定义登陆页

1 在templates目录下 新建admin目录

2 新建login.html 复制源码login.html

3 找到对应block 加入自己的内容就可以了

# 缓存

## 	数据库方式

​	1 在settings.py里加数据库配置

~~~
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.db.DatabaseCache',
        'LOCATION': 'my_cache_table',
        'TIMEOUT': '60',
        'OPTIONS': {
            'MAX_ENTRIES': '300',
        },
        'KEY_PREFIX': 'rock',
        'VERSION': '1',
    }
}
~~~

​	2 创建缓存表

~~~
python manage.py createcachetable
~~~

## 	redis的方式

​	配置如下

~~~
CACHES = {
    "default": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://127.0.0.1:6379/1",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    }
}
~~~

## 缓存的使用（可以减轻服务器和数据库的压力，轻快响应速度，提高用户体验，还可做数据的时效需求）

## 	1 页面级别的缓存  使用cache_page(60) 装饰器 其中60表示缓存60秒数据

​	1 页面级别的缓存  使用cache_page(60) 装饰器 其中60表示缓存60秒数据

~~~
@cache_page(60)		
def get_data(req):
	#假装在拼命的查数据库
    time.sleep(5)
    return HttpResponse("睡醒了")
~~~

​	2 原生底层 （参考画图 那个png文件）

~~~
from django.core.cache import cache

def get_players(req):
    # 在缓存尝试拿数据
    data = cache.get("players")
    if data:
        # 如果拿到缓存数据 直接返回
        return HttpResponse(data)
    else:
        # 没拿到
        # 假装拿很久
        time.sleep(5)
        # 拿数据
        players = Player.objects.all()
        # 设置缓存
        cache.set("players", players, 30)
        return HttpResponse(players)
~~~

